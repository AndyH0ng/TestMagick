// ─── Page Setup ───
#set page(
  paper: "a4",
  margin: (top: 25mm, bottom: 22mm, left: 25mm, right: 25mm),
  footer: context {
    set text(size: 8.5pt, fill: luma(140))
    align(center)[Page #counter(page).display() of #counter(page).final().first()]
  },
)

#set text(
  font: ("New Computer Modern", "NanumMyeongjo", "AppleMyungjo", "Libertinus Serif"),
  size: 11pt,
  lang: "ko",
)

#set par(
  leading: 0.72em,
  first-line-indent: 0pt,
  justify: true,
)

// ─── Header ───
#align(center)[
  {% if course %}
  #text(size: 12pt, weight: "bold")[#{{ course | typst_string }}]
  #v(2pt)
  {% endif %}
  #text(size: 16pt, weight: "bold")[#{{ title | typst_string }}]
  #v(2pt)
  #text(size: 12pt, weight: "bold")[Answer Key]
  {% if date %}
  #v(2pt)
  #text(size: 10.5pt)[#{{ date | typst_string }}]
  {% endif %}
]

#v(10pt)
#line(length: 100%, stroke: 0.8pt)

// ─── Answer Summary Table ───
#v(14pt)
#align(center)[
  #text(size: 10.5pt, weight: "bold")[Answer Summary]
]
#v(6pt)
#align(center)[
  #table(
    columns: ({% for p in problems %}38pt{% if not loop.last %}, {% endif %}{% endfor %}),
    align: center + horizon,
    stroke: 0.4pt + luma(160),
    inset: 6pt,
    ..for i in range({{ problems | length }}) {
      (table.cell(fill: luma(240))[#text(size: 8.5pt, weight: "bold")[#str(i + 1)]],)
    },
{% for p in problems %}
    [#text(size: 9.5pt, weight: "bold")[{{ p.answer_label }}]],
{% endfor %}
  )
]

#v(20pt)
#line(length: 100%, stroke: 0.4pt + luma(180))
#v(16pt)

// ─── Detailed Solutions ───
{% for p in problems %}
#block(
  width: 100%,
  breakable: true,
  above: {% if loop.first %}0pt{% else %}14pt{% endif %},
  below: 0pt,
)[
  #grid(
    columns: (auto, 1fr, auto),
    align: horizon,
    text(weight: "bold", size: 11pt)[{{ loop.index }}. \[{{ p.id }}\]],
    [],
    text(size: 9.5pt, weight: "bold")[Answer: {{ p.answer_label }}{% if p.type == "mcq" %}.{% endif %}],
  )

  #v(4pt)
  #pad(left: 16pt)[
{% if p.answer_is_typst %}
{{ p.answer_text }}
{% else %}
#{{ p.answer_text | typst_string }}
{% endif %}
  ]

{% if p.source or p.tags_text %}
  #v(3pt)
  #pad(left: 16pt)[
    #set text(size: 9pt, fill: luma(120), style: "italic")
{% if p.source %}
    Source: #{{ p.source | typst_string }}
{% endif %}
{% if p.source and p.tags_text %}
    #h(8pt)
{% endif %}
{% if p.tags_text %}
    Tags: #{{ p.tags_text | typst_string }}
{% endif %}
  ]
{% endif %}

{% if not loop.last %}
  #v(8pt)
  #line(length: 100%, stroke: 0.3pt + luma(210))
{% endif %}
]
{% endfor %}
